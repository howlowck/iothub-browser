function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=e(require("create-hmac")),t=e(require("rhea")),o=e(require("debug")),i=require("mqtt"),c=function(e){return Math.ceil(Date.now()/1e3+60*e)},r=function(e){return"SharedAccessSignature "+["sr","sig","se","skn"].map(function(n){return e[n]?n+"="+e[n]:null},"").filter(function(e){return e}).join("&")},s=function(e,t,o,i){var c=encodeURIComponent(e),r={_key:o,sr:c,se:i,sig:function(e,t,o){var i=e+"\n"+o,c=n("sha256",new Buffer(t,"base64"));c.update(i);var r=c.digest("base64");return encodeURIComponent(r)}(c,o,i)};return t&&(r.skn=t),r},a=function(e){return e.split(";").reduce(function(e,n,t){var o=n.search("="),i=n.slice(0,o),c=n.slice(o+1);return e[i]=c,e},{})},u=function(e){return e.slice(5,-1)},d=o("monitor-events");var l=o("device");exports.monitorEvents=function(e,n,o){var i,c=a(n),r=u(c.Endpoint),s=c.SharedAccessKeyName,l=c.SharedAccessKey,m="wss://"+r+":443/$servicebus/websocket?iothub-no-client-cert=true",p=t.websocket_connect(WebSocket),f=t.connect({hostname:r,container_id:"conn"+Date.now(),max_frame_size:4294967295,channel_max:65535,idle_timeout:12e4,outgoing_locales:"en-US",incoming_locales:"en-US",offered_capabilities:null,desired_capabilities:null,properties:{},connection_details:p(m,["AMQPWSB10"]),reconnect:!1,username:s,password:l});t.on("connection_open",function(e){f.open_receiver("$management"),i=f.open_sender("$management")}),t.once("sendable",function(n){i.send({body:"[]",application_properties:{operation:"READ",name:e,type:"com.microsoft:eventhub"}})});var b="amqp.annotation.x-opt-enqueuedtimeutc > '"+Date.now()+"'";return t.once("message",function(e){d("monitoring from eventhub endpoint on iothub ..."),e.message.body.partition_ids.forEach(function(e){f.attach_receiver(function(e){return{desired_capabilities:"com.microsoft:enable-receiver-runtime-metric",autoaccept:!0,source:{address:"hao-gl-iothub/ConsumerGroups/$default/Partitions/"+e,filter:{"apache.org:selector-filter:string":t.types.wrap_described(b,77567109365764)}}}}(e))}),t.on("message",function(e){d(e),o(e.message.body.content.toString(),e)})}),{close:f.close.bind(f)}},exports.connectDevice=function(e,n){var t=c(60),o=a(e),u=o.HostName,d=o.DeviceId,m=s(u+"/devices/"+d,null,o.SharedAccessKey,t),p=r(m),f=i.connect("wss://"+u+":443/$iothub/websocket?iothub-no-client-cert=true",{clean:!1,clientId:d,keepalive:180,password:p,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,rejectUnauthorized:!0,connectTimeout:3e4,reschedulePings:!0,username:u+"/"+d+"/api-version=2017-06-30"});return f.on("connect",function(){l("emitter connected!")}),f.on("offline",function(){l("emitter offline")}),f.on("close",function(){l("emitter closed!")}),f.on("message",n),f.on("packetsend",function(){l("trying to send pocket..")}),f.subscribe("devices/"+d+"/messages/devicebound/#",{qos:0}),{publish:function(e,n){void 0===n&&(n={});var t=Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&");f.publish("devices/"+d+"/messages/events/"+t,e,{qos:1,retain:!1})},close:f.end.bind(f)}};
//# sourceMappingURL=index.js.map
