import"create-hmac";import e from"rhea";import n from"debug";var o=function(e){return e.split(";").reduce(function(e,n,o){var t=n.search("="),i=n.slice(0,t),r=n.slice(t+1);return e[i]=r,e},{})},t=function(e){return e.slice(5,-1)},i=n("monitor-events");export default function(n,r,c){var a,s=o(r),u=t(s.Endpoint),m=s.SharedAccessKeyName,d=s.SharedAccessKey,l="wss://"+u+":443/$servicebus/websocket?iothub-no-client-cert=true",p=e.websocket_connect(WebSocket),f=e.connect({hostname:u,container_id:"conn"+Date.now(),max_frame_size:4294967295,channel_max:65535,idle_timeout:12e4,outgoing_locales:"en-US",incoming_locales:"en-US",offered_capabilities:null,desired_capabilities:null,properties:{},connection_details:p(l,["AMQPWSB10"]),reconnect:!1,username:m,password:d});e.on("connection_open",function(e){f.open_receiver("$management"),a=f.open_sender("$management")}),e.once("sendable",function(e){a.send({body:"[]",application_properties:{operation:"READ",name:n,type:"com.microsoft:eventhub"}})});var b="amqp.annotation.x-opt-enqueuedtimeutc > '"+Date.now()+"'";return e.once("message",function(n){i("monitoring from eventhub endpoint on iothub ..."),n.message.body.partition_ids.forEach(function(n){f.attach_receiver(function(n){return{desired_capabilities:"com.microsoft:enable-receiver-runtime-metric",autoaccept:!0,source:{address:"hao-gl-iothub/ConsumerGroups/$default/Partitions/"+n,filter:{"apache.org:selector-filter:string":e.types.wrap_described(b,77567109365764)}}}}(n))}),e.on("message",function(e){i(e),c(e.message.body.content.toString(),e)})}),{close:f.close.bind(f)}};
//# sourceMappingURL=monitorEvents.mjs.map
