function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=e(require("create-hmac")),t=require("mqtt"),o=function(e){return Math.ceil(Date.now()/1e3+60*e)},r=function(e){return"SharedAccessSignature "+["sr","sig","se","skn"].map(function(n){return e[n]?n+"="+e[n]:null},"").filter(function(e){return e}).join("&")},c=function(e,t,o,r){var c=encodeURIComponent(e),i={_key:o,sr:c,se:r,sig:function(e,t,o){var r=e+"\n"+o,c=n("sha256",new Buffer(t,"base64"));c.update(r);var i=c.digest("base64");return encodeURIComponent(i)}(c,o,r)};return t&&(i.skn=t),i},i=function(e){return e.split(";").reduce(function(e,n,t){var o=n.search("="),r=n.slice(0,o),c=n.slice(o+1);return e[r]=c,e},{})},s=e(require("debug"))("device");module.exports=function(e,n){var u=o(60),a=i(e),d=a.HostName,f=a.DeviceId,l=c(d+"/devices/"+f,null,a.SharedAccessKey,u),p=r(l),m=t.connect("wss://"+d+":443/$iothub/websocket?iothub-no-client-cert=true",{clean:!1,clientId:f,keepalive:180,password:p,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,rejectUnauthorized:!0,connectTimeout:3e4,reschedulePings:!0,username:d+"/"+f+"/api-version=2017-06-30"});return m.on("connect",function(){s("emitter connected!")}),m.on("offline",function(){s("emitter offline")}),m.on("close",function(){s("emitter closed!")}),m.on("message",n),m.on("packetsend",function(){s("trying to send pocket..")}),m.subscribe("devices/"+f+"/messages/devicebound/#",{qos:0}),{publish:function(e,n){void 0===n&&(n={});var t=Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&");m.publish("devices/"+f+"/messages/events/"+t,e,{qos:1,retain:!1})},close:m.end.bind(m)}};
//# sourceMappingURL=connectDevice.js.map
