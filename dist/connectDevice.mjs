import e from"create-hmac";import{connect as n}from"mqtt";import o from"debug";var t=function(e){return Math.ceil(Date.now()/1e3+60*e)},r=function(e){return"SharedAccessSignature "+["sr","sig","se","skn"].map(function(n){return e[n]?n+"="+e[n]:null},"").filter(function(e){return e}).join("&")},c=function(n,o,t,r){var c=encodeURIComponent(n),i={_key:t,sr:c,se:r,sig:function(n,o,t){var r=n+"\n"+t,c=e("sha256",new Buffer(o,"base64"));c.update(r);var i=c.digest("base64");return encodeURIComponent(i)}(c,t,r)};return o&&(i.skn=o),i},i=function(e){return e.split(";").reduce(function(e,n,o){var t=n.search("="),r=n.slice(0,t),c=n.slice(t+1);return e[r]=c,e},{})},s=o("device");export default function(e,o){var u=t(60),a=i(e),d=a.HostName,f=a.DeviceId,l=c(d+"/devices/"+f,null,a.SharedAccessKey,u),m=r(l),p=n("wss://"+d+":443/$iothub/websocket?iothub-no-client-cert=true",{clean:!1,clientId:f,keepalive:180,password:m,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,rejectUnauthorized:!0,connectTimeout:3e4,reschedulePings:!0,username:d+"/"+f+"/api-version=2017-06-30"});return p.on("connect",function(){s("emitter connected!")}),p.on("offline",function(){s("emitter offline")}),p.on("close",function(){s("emitter closed!")}),p.on("message",o),p.on("packetsend",function(){s("trying to send pocket..")}),p.subscribe("devices/"+f+"/messages/devicebound/#",{qos:0}),{publish:function(e,n){void 0===n&&(n={});var o=Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&");p.publish("devices/"+f+"/messages/events/"+o,e,{qos:1,retain:!1})},close:p.end.bind(p)}};
//# sourceMappingURL=connectDevice.mjs.map
