import e from"create-hmac";import n from"rhea";import o from"debug";import{connect as t}from"mqtt";var i=function(e){return Math.ceil(Date.now()/1e3+60*e)},r=function(e){return"SharedAccessSignature "+["sr","sig","se","skn"].map(function(n){return e[n]?n+"="+e[n]:null},"").filter(function(e){return e}).join("&")},c=function(n,o,t,i){var r=encodeURIComponent(n),c={_key:t,sr:r,se:i,sig:function(n,o,t){var i=n+"\n"+t,r=e("sha256",new Buffer(o,"base64"));r.update(i);var c=r.digest("base64");return encodeURIComponent(c)}(r,t,i)};return o&&(c.skn=o),c},s=function(e){return e.split(";").reduce(function(e,n,o){var t=n.search("="),i=n.slice(0,t),r=n.slice(t+1);return e[i]=r,e},{})},a=function(e){return e.slice(5,-1)},u=o("monitor-events");function d(e,o,t){var i,r=s(o),c=a(r.Endpoint),d=r.SharedAccessKeyName,m=r.SharedAccessKey,l="wss://"+c+":443/$servicebus/websocket?iothub-no-client-cert=true",p=n.websocket_connect(WebSocket),f=n.connect({hostname:c,container_id:"conn"+Date.now(),max_frame_size:4294967295,channel_max:65535,idle_timeout:12e4,outgoing_locales:"en-US",incoming_locales:"en-US",offered_capabilities:null,desired_capabilities:null,properties:{},connection_details:p(l,["AMQPWSB10"]),reconnect:!1,username:d,password:m});n.on("connection_open",function(e){f.open_receiver("$management"),i=f.open_sender("$management")}),n.once("sendable",function(n){i.send({body:"[]",application_properties:{operation:"READ",name:e,type:"com.microsoft:eventhub"}})});var b="amqp.annotation.x-opt-enqueuedtimeutc > '"+Date.now()+"'";return n.once("message",function(e){u("monitoring from eventhub endpoint on iothub ..."),e.message.body.partition_ids.forEach(function(e){f.attach_receiver(function(e){return{desired_capabilities:"com.microsoft:enable-receiver-runtime-metric",autoaccept:!0,source:{address:"hao-gl-iothub/ConsumerGroups/$default/Partitions/"+e,filter:{"apache.org:selector-filter:string":n.types.wrap_described(b,77567109365764)}}}}(e))}),n.on("message",function(e){u(e),t(e.message.body.content.toString(),e)})}),{close:f.close.bind(f)}}var m=o("device");function l(e,n){var o=i(60),a=s(e),u=a.HostName,d=a.DeviceId,l=c(u+"/devices/"+d,null,a.SharedAccessKey,o),p=r(l),f=t("wss://"+u+":443/$iothub/websocket?iothub-no-client-cert=true",{clean:!1,clientId:d,keepalive:180,password:p,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,rejectUnauthorized:!0,connectTimeout:3e4,reschedulePings:!0,username:u+"/"+d+"/api-version=2017-06-30"});f.on("connect",function(){m("emitter connected!")}),f.on("offline",function(){m("emitter offline")}),f.on("close",function(){m("emitter closed!")}),f.on("message",n),f.on("packetsend",function(){m("trying to send pocket..")}),f.subscribe("devices/"+d+"/messages/devicebound/#",{qos:0});return{publish:function(e,n){void 0===n&&(n={});var o=Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&");f.publish("devices/"+d+"/messages/events/"+o,e,{qos:1,retain:!1})},close:f.end.bind(f)}}export{d as monitorEvents,l as connectDevice};
//# sourceMappingURL=index.mjs.map
