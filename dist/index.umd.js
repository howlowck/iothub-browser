!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("create-hmac"),require("rhea"),require("debug"),require("mqtt")):"function"==typeof define&&define.amd?define(["exports","create-hmac","rhea","debug","mqtt"],n):n(e.iothubBrowser={},e.createHmac,e.rhea,e.debug,e.mqtt)}(this,function(e,n,t,o,i){n=n&&n.hasOwnProperty("default")?n.default:n,t=t&&t.hasOwnProperty("default")?t.default:t;var r=function(e){return Math.ceil(Date.now()/1e3+60*e)},c=function(e){return"SharedAccessSignature "+["sr","sig","se","skn"].map(function(n){return e[n]?n+"="+e[n]:null},"").filter(function(e){return e}).join("&")},s=function(e,t,o,i){var r=encodeURIComponent(e),c={_key:o,sr:r,se:i,sig:function(e,t,o){var i=e+"\n"+o,r=n("sha256",new Buffer(t,"base64"));r.update(i);var c=r.digest("base64");return encodeURIComponent(c)}(r,o,i)};return t&&(c.skn=t),c},a=function(e){return e.split(";").reduce(function(e,n,t){var o=n.search("="),i=n.slice(0,o),r=n.slice(o+1);return e[i]=r,e},{})},u=function(e){return e.slice(5,-1)},d=(o=o&&o.hasOwnProperty("default")?o.default:o)("monitor-events");var f=o("device");e.monitorEvents=function(e,n,o){var i,r=a(n),c=u(r.Endpoint),s=r.SharedAccessKeyName,f=r.SharedAccessKey,l="wss://"+c+":443/$servicebus/websocket?iothub-no-client-cert=true",m=t.websocket_connect(WebSocket),p=t.connect({hostname:c,container_id:"conn"+Date.now(),max_frame_size:4294967295,channel_max:65535,idle_timeout:12e4,outgoing_locales:"en-US",incoming_locales:"en-US",offered_capabilities:null,desired_capabilities:null,properties:{},connection_details:m(l,["AMQPWSB10"]),reconnect:!1,username:s,password:f});t.on("connection_open",function(e){p.open_receiver("$management"),i=p.open_sender("$management")}),t.once("sendable",function(n){i.send({body:"[]",application_properties:{operation:"READ",name:e,type:"com.microsoft:eventhub"}})});var b="amqp.annotation.x-opt-enqueuedtimeutc > '"+Date.now()+"'";return t.once("message",function(e){d("monitoring from eventhub endpoint on iothub ..."),e.message.body.partition_ids.forEach(function(e){p.attach_receiver(function(e){return{desired_capabilities:"com.microsoft:enable-receiver-runtime-metric",autoaccept:!0,source:{address:"hao-gl-iothub/ConsumerGroups/$default/Partitions/"+e,filter:{"apache.org:selector-filter:string":t.types.wrap_described(b,77567109365764)}}}}(e))}),t.on("message",function(e){d(e),o(e.message.body.content.toString(),e)})}),{close:p.close.bind(p)}},e.connectDevice=function(e,n){var t=r(60),o=a(e),u=o.HostName,d=o.DeviceId,l=s(u+"/devices/"+d,null,o.SharedAccessKey,t),m=c(l),p=i.connect("wss://"+u+":443/$iothub/websocket?iothub-no-client-cert=true",{clean:!1,clientId:d,keepalive:180,password:m,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,rejectUnauthorized:!0,connectTimeout:3e4,reschedulePings:!0,username:u+"/"+d+"/api-version=2017-06-30"});return p.on("connect",function(){f("emitter connected!")}),p.on("offline",function(){f("emitter offline")}),p.on("close",function(){f("emitter closed!")}),p.on("message",n),p.on("packetsend",function(){f("trying to send pocket..")}),p.subscribe("devices/"+d+"/messages/devicebound/#",{qos:0}),{publish:function(e,n){void 0===n&&(n={});var t=Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&");p.publish("devices/"+d+"/messages/events/"+t,e,{qos:1,retain:!1})},close:p.end.bind(p)}}});
//# sourceMappingURL=index.umd.js.map
